<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script>

    console.log("TURF HTML LOADED");

    // ============================================================
    //  READY FLAG → memberi tahu Android bahwa JS sudah siap
    // ============================================================
    window.androidReady = false;
    window.__pendingCourierSet = null;

    function onAndroidReady() {
        window.androidReady = true;
        console.log("[JS] Android READY");

        // Jika Android sudah mengirim courier sebelum JS siap
        if (window.__pendingCourierSet) {
            console.log("[JS] Executing pending courier position...");
            eval(window.__pendingCourierSet);
            window.__pendingCourierSet = null;
        }
    }

    // ============================================================
    // Simpan posisi kurir
    // ============================================================
    window.courierLat = null;
    window.courierLng = null;

    function setCourierPosition(lng, lat) {
        window.courierLat = lat;
        window.courierLng = lng;
        console.log("[JS] Courier position SET:", lat, lng);
    }


    // ===================================================================
    // MAKE BUFFER
    // ===================================================================
    function makeBuffer(lineGeoJson, km) {
        console.log("[JS] makeBuffer() CALLED");
        console.log("[JS] km =", km);

        try {
            if (typeof lineGeoJson === "string") {
                console.log("[JS] Parsing lineGeoJson string...");
                lineGeoJson = JSON.parse(lineGeoJson);
            }

            const feature = (lineGeoJson.type === "Feature")
                ? lineGeoJson
                : turf.feature(lineGeoJson);

            console.log("[JS] Feature loaded. First coordinate:", feature.geometry.coordinates[0]);

            // Simplify route
            const simplified = turf.simplify(feature, { tolerance: 0.0001, highQuality: false });
            console.log("[JS] Route simplified. Coordinate count:", simplified.geometry.coordinates.length);

            // Create buffer polygon
            const buffered = turf.buffer(simplified, km, { units: "kilometers" });
            console.log("[JS] Buffer created. Polygon points:", buffered.geometry.coordinates[0].length);

            window.bufferPolygon = buffered;

            // Callback ke Android
            if (window.Android?.onBufferCreated) {
                Android.onBufferCreated(JSON.stringify(buffered));
            }

            // Auto-check courier position
            if (window.courierLat != null && window.courierLng != null) {
                console.log("[JS] Auto-checking courier inside polygon...");
                checkPointInside([window.courierLng, window.courierLat], window.bufferPolygon);
            } else {
                console.log("[JS] Courier position NOT SET → skipping auto-check.");
            }

        } catch (e) {
            Android.onJsError("makeBuffer error: " + e.message);
        }
    }

    // ===================================================================
    // CHECK POINT IN GEOMETRY
    // ===================================================================
    function checkPointInside(pointArr, polygonObj) {
        try {
            console.log("[JS] checkPointInside() CALLED");
            console.log("[JS] point =", pointArr);

            let poly = polygonObj;
            if (typeof poly === "string") {
                console.log("[JS] parsing polygon JSON string");
                poly = JSON.parse(poly);
            }

            console.log("[JS] polygon vertex count =", poly.geometry.coordinates[0].length);

            const pt = turf.point(pointArr);
            const inside = turf.booleanPointInPolygon(pt, poly);

            console.log("[JS] INSIDE RESULT =", inside);

            Android.onPointCheck(inside ? "inside" : "outside");

        } catch (e) {
            Android.onJsError("checkPointInside error: " + e.message);
        }
    }

    // ============================================================
    // PANGGIL READY SETELAH SCRIPT BERES TERLOAD
    // ============================================================
    window.addEventListener("load", () => {
        console.log("[JS] window load completed.");
        onAndroidReady();
    });


</script>
